## Apollo规划技术详解——优化内部运动规划

在自动驾驶软件的开发中，**运动规划**是最核心的模块之一。它将综合**感知、定位和地图**等信息，规划出无人车未来一段时间（约10秒）的一系列动作指令（方向盘转角、油门、刹车等）。



运动规划的问题——**目标函数（objective function）** **和约束（constraint**）。

运动规划的最终目的就是找出一条最优的运动轨迹，使其能够最小化（或者最大化）目标函数，并且不违背任何约束。

>  在自动驾驶中，可以将环境抽象成SL坐标系，在此坐标下的曲线光滑度是有要求的，因此需要对轨迹线进行平滑处理。

约束问题的核心有三点

- 第一是**目标函数的定义**，目标函数比较清晰，对于后面的求解更有帮助。
- 第二是**约束**，比如路网约束、交规、动态约束等。
- 第三是**约束问题的优化**，比如动态规划、二次规划等。

# 动态规划

**动态规划**通过类似于有限元的方式，把问题从连续空间抽象成离散空间，然后在离散空间中进行优化。虽然这种方法可以逼近连续空间中的最优解，但是**计算复杂度很高**。针对计算时间长的问题，可以使用牛顿方法进行优化，它的收敛次数是指数平方，也叫二次收敛（二次规划）。

![图片](https://mmbiz.qpic.cn/mmbiz_png/Lic3WIjno4gxRrFqUicyaYCWO9eVlhSDVzcKmjN5MVG3PymCZBrKAKmnwicllia3dicNicicGfzCticosYpEwbPtWhMiawA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

**▲二次规划算法**

# 二次规划

**二次规划算法的本质**是牛顿法的 Taylor 展开，但是它的求解过程涉及更复杂的情况。因为二次规划方法并不一定是处理一维问题，可能涉及更高阶求导。在实践中，二阶导数基本可以满足问题需求。



# 二次规划问题的求解方法

然而，牛顿法要求 locally convex 才能保证收敛，也就是导数是严格单调递增的。但是一般函数并没有这样的特性，**动态规划**或**二次规划**都无法获得全局最优解。为了解决这样的问题，通常使用**启发式搜索方法**。

首先通过**动态规划方式**对整个问题有一个粗浅的认识，然后通过**二次规划**进行细化。

这种<u>启发式搜索方法</u>也是目前百度 Apollo 的 EM 算法的核心思想。

这种方法和人开车的过程是一样的，通常驾驶员会先形成一个大概的指导思想，指明往什么方向开，然后再规划一条最优路径。

**决策问题**是一个离散空间中的优化问题，它的决定是什么？可以通过动态规划对整个空间先形成一个粗浅的认识，然后以此为启发，用二次规划求最优解。

总的来说，对于求解非线性优化问题（自动驾驶中的规划基本都是非线性的），通常就是用启发式方法来求解。先用动态规划给出一个粗略解，给出一个凸空间。然后用二次规划方法在凸空间里去寻找最优解，如下图所示。

![image-20210822221337329](C:\Users\HW\AppData\Roaming\Typora\typora-user-images\image-20210822221337329.png)

​																	**▲求解非线性优化问题**

