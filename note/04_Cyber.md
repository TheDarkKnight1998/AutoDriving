









# Apollo Cyber RT

### 什么是Cyber RT？

Cyber RT是百度Apollo推出的代替ROS的消息中间件，它是一个开源、高性能的运行时框架，专为自动驾驶场景而设计。基于中心化的计算模型，针对自动驾驶的高并发、低延迟、高吞吐进行了大幅优化。 自动驾驶的各个模块通过Cyber进行消息的订阅和发布，同时Cyber还提供了任务调度，录制bag包等功能。通过Cyber实现了自动驾驶的中间层。

### 为什么需要Cyber RT？

Apollo 3.5以前使用的系统为ROS，各节点之间的通信方式为进程间的通信。在实际的应用中，ROS在自动驾驶领域遇到很多挑战：

- 首先ROS的算法模块以独立进程的形式存在，独立进程的节点的运行顺序无法确定，因此业务逻辑的调度顺序无法保证。
- 其次，ROS是一个分布式的系统，存在通信的开销。
- 此外，ROS系统中还存在其他很多不确定的地方，比如内存的动态申请。ROS的资源分配时不确定的，

### Cyber RT在Apollo系统中扮演的角色？

Cyber主要的作用就是一个消息中间件，它们需要管理不同的模块，并让它们互相之间可以高效通信。在Apollo6.0中，它作为RTOS和自动驾驶各个模块的中间通信接口。

![image-20220316213737771](D:\自动驾驶\AutoDriving\note\picture\image-20220316213737771.png)

### Cyber RT实现的主要功能

Cyber是一个分布式收发消息，和调度的框架，同时对外提供一系列的工具和井口来辅助开发和定位问题。Cyber提供的功能主要包括一下方面：

- **消息队列：** 主要作用是接收和发送各个节点的消息，涉及到消息的发布、订阅以及消息的buffer缓存等。
- **实时调度：** 主要作用是调度处理上述消息的算法模块，保证算法模块能够实时调度处理消息。
- **用户接口：** Cyber提供了灵活的用户接口(?)
- **开发工具：** 提供了一系列的工具包括消息监控(Cyber_monitor)，消息可视化(Cyber_visualizer)，录制/回放工具(Cyber_recorder), ros包录制(rosbag_to_recorder)。

### Cyber RT的架构

Cyber RT的框架如下图所示：

- 基础库：Cyber RT为了高性能和减少依赖，实现了自己的基础库。(Lock-free的对象池，队列)
- 通信层：Publish/Subscribe机制，Service/Client机制，服务自发现，自适应的通信机制（共享内存、Socket、进程内存）
- 数据缓存/融合层：数据缓存与融合。多路传感器之间数据需要融合，而且算法可能需要缓存一定的数据。比如典型的仿真应用，不同算法模块之间需要有一个数据桥梁，数据层起到了这个模块间通信的桥梁的作用
- 计算层：计算模型，任务以及任务调度
- 接口： Cyber RT为开发者提供了component类，开发者的算法业务模块只需要继承该类，实现其中的proc接口即可。该接口类似于ROS的callback，消息通过参数的方式传递。此外Cyber RT也提供了并行计算的相关接口以及用于开发调试、录制回放的工具。

![image-20220317225004625](D:\自动驾驶\AutoDriving\note\picture\image-20220317225004625.png)

- 最下层是 线控，和执行器相关，车为什么叫执行器呢？因为比如刹车，这是硬件刹车，需要用电信号去驱动，所以叫线控。所以要用线把执行器连接起来

- 上一层是传感器

- 再往上是车辆软件栈，操作系统（RTOS（提高吞吐，不想任务被打断，提高了时钟频率，和终端线程化））

- 再往上是中间件
- 再往上应用节点





# 参考 

https://zhuanlan.zhihu.com/p/397607823

